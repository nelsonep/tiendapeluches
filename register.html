<html>

<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">

  <!-- JavaScript Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
    crossorigin="anonymous"></script>
</head>

<body>
  <div class="row g-3">
    <div class="col-md-6">
      <label for="inputnombre" class="form-label">Nombre</label>
      <input type="text" class="form-control" id="inputnombre">
    </div>
    <div class="col-md-6">
      <label for="inputapellidos" class="form-label">Apellidos</label>
      <input type="text" class="form-control" id="inputapellidos">
    </div>

    <div class="col-md-6">
      <label for="inputEmail" class="form-label">Email</label>
      <input type="email" class="form-control" id="inputEmail">
    </div>
    <div class="col-md-6">
      <label for="inputdireccion" class="form-label">Direcci칩n</label>
      <input type="text" class="form-control" id="inputdireccion">
    </div>

    <div class="col-md-6">
      <label for="inputcel" class="form-label">Celular</label>
      <input type="text" class="form-control" id="inputcel">
    </div>
    <div class="col-md-6">
      <label for="inputedad" class="form-label">Edad</label>
      <input type="number" class="form-control" id="inputedad">
    </div>
    <div class="col-md-4">
      <label for="inputalergias" class="form-label">Alergias</label>
      <input type="text" class="form-control" id="inputalergias">
    </div>
    <div class="col-md-4">
      <label for="inputtamanno" class="form-label">Tama침o que desea</label>
      <input type="text" class="form-control" id="inputtamanno">
    </div>
    <div class="col-md-4">
      <label for="inputedad" class="form-label">Foto</label>
      <input type="file" class="form-control" id="inputfoto" onchange="readURL(this)">
    </div>
    <div class="col-md-12">

      <img id="inputimagenminiatura" src="" style='border-radius: 50%;cursor:pointer;width:100px;' />
    </div>
    <hr>
    <div class="col-md-4">
      <label for="inputcolor" class="form-label"> Color </label>
      <input type="text" class="form-control" id="inputcolor">
    </div>
    <div class="col-md-4">
      <label for="inputforma" class="form-label"> Forma </label>
      <input type="text" class="form-control" id="inputforma">
    </div>
    <div class="col-md-2">
      <label for="inputfotopeluche" class="form-label">Imagen de ejemplo:</label>
      <input type="file" class="form-control" id="inputfotopeluche" onchange="readURLpeluche(this)">
      <img id="inputimagenminiaturapeluche" src="" style='border-radius: 50%;cursor:pointer;width:70px;' />
    </div>
    <div class="col-md-2">
      <button class="btn btn-primary" onclick="agregarpeluche()">Agregar</button>
    </div>
    <table class="table">
      <thead>
        <tr>
          <th scope="col">Forma</th>
          <th scope="col">Color</th>
          <th scope="col">Foto</th>
          <th scope="col">Eliminar</th>
        </tr>
      </thead>
      <tbody id='filasdepeluches'>

      </tbody>
    </table>
    <hr>

    <div class="col-12">
      <button class="btn btn-primary" onclick="registrarse()">Registrarse</button>

      <button class="btn btn-primary" onclick="listar()">lista</button>
    </div>
  </div>

  <table class="table">
    <thead>
      <tr>
        <th scope="col">Foto</th>
        <th scope="col">Nombre</th>
        <th scope="col">Apellidos</th>
        <th scope="col">Email</th>
        <th scope="col">Direccion</th>
        <th scope="col">Celular</th>
        <th scope="col">Edad</th>
        <th scope="col">Alergias</th>
        <th scope="col">Tama침o</th>
        <th scope="col">Peluche</th>
        <th scope="col">Modificar</th>
        <th scope="col">Eliminar</th>
      </tr>
    </thead>
    <tbody id='filasdelatabla'>

    </tbody>
  </table>

  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Modificar persona</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">


          <div class="row g-3">
            <div class="col-md-12">
              <img id='imgregistroengrande' src='' style="border-radius: 50%;cursor:pointer;width:200px;" />
            </div>

            <input type='hidden' id='idamodificar' value='' />

            <div class="col-md-6">
              <label for="inputnombre" class="form-label">Nombre</label>
              <input type="text" class="form-control" id="inputnombremod" disabled>
            </div>
            <div class="col-md-6">
              <label for="inputapellidos" class="form-label">Apellidos</label>
              <input type="text" class="form-control" id="inputapellidosmod">
            </div>

            <div class="col-md-6">
              <label for="inputEmail" class="form-label">Email</label>
              <input type="email" class="form-control" id="inputEmailmod">
            </div>
            <div class="col-md-6">
              <label for="inputdireccion" class="form-label">Direcci칩n</label>
              <input type="text" class="form-control" id="inputdireccionmod">
            </div>

            <div class="col-md-6">
              <label for="inputcel" class="form-label">Celular</label>
              <input type="text" class="form-control" id="inputcelmod">
            </div>
            <div class="col-md-4">
              <label for="inputedad" class="form-label">Edad</label>
              <input type="number" class="form-control" id="inputedadmod">
            </div>
            <div class="col-md-6">
              <label for="inputcel" class="form-label">Alergias</label>
              <input type="text" class="form-control" id="inputalergiasmod">
            </div>
            <div class="col-md-4">
              <label for="inputcel" class="form-label">tamanno</label>
              <input type="text" class="form-control" id="inputtamannomod">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          <button type="button" class="btn btn-primary" onclick="modificarconajax()">Modificar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="ModalFoto" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Foto del peluche</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <h1 id='nombrepelucheendetalle'></h1>

          <img id='fotoengrandepeluche' src='' style="border-radius: 50%;cursor:pointer;width:200px;" />

          <label for="inputfotopeluche" class="form-label">Nueva foto del peluche:</label>
          <input type="file" class="form-control" id="inputfotopeluche" onchange="readURLpeluchemod(this)">
          <div class="col-md-6">
            <label for="inputcolor" class="form-label">Color</label>
            <input type="text" class="form-control" id="inputcolormod" disabled>
          </div>
          <div class="col-md-6">
            <label for="inputforma" class="form-label">Forma</label>
            <input type="text" class="form-control" id="inputformamod">
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          <button type="button" class="btn btn-primary" onclick="modificarfotopeluche()">Modificar</button>
        </div>
      </div>
    </div>

  </div>



  <script src='https://code.jquery.com/jquery-3.5.1.js' integrity='sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc='
    crossorigin='anonymous'>

    </script>
  <script>
    //VARIABLE PARA GUARDAR LA IMG EN CODIFICACION BASE 64
    var imagenenbase64 = "";
    var listadepersonas;

    //FUNCION QUE S EEJECUTA ANTE ALGUN CAMBIO EN EL INPUT DE IMAGEN
    function readURL(input) {
      //SI HAY ALGUN ARCHIVO EN EL INPUT
      if (input.files && input.files[0]) {
        //SI EL ARCHIVO ES MENOR A 2 MEGAS
        if (input.files[0].size < 2097152) {
          //CREO UNA VARIABLE TIPO FILEREADER
          var reader = new FileReader();
          console.log(input.files[0]);
          tipodedig = input.files[0].type;
          nombredelpdf = input.files[0].name;
          reader.onload = function (e) {
            //CUANDO LA VARIABLE FILEREADER ES CARGADA CON UN ARCHIVO
            //GUARDO LA IMAGEN EN BASE64 EN LA VARIABLE
            imagenenbase64 = e.target.result;



            //MUESTOR LA IMAGEN EN BASE64 EN UNA ETIQUETE IMG
            document.getElementById("inputimagenminiatura").src = imagenenbase64;
          };
          //PONGO AL FILEREADER A LLER EL ARCHIVO DE LA IMAGEN
          reader.readAsDataURL(input.files[0]);

        }
        else {

          alert("Archivo demasiado grande, excede los 2 MB de limite por archivo, intente con un formato menos pesado");
        }
      }
    }



    var imagenenbase64peluche = "";
    function readURLpeluchemod(input) {
      if (input.files && input.files[0]) {
        //SI EL ARCHIVO ES MENOR A 2 MEGAS
        if (input.files[0].size < 2097152) {
          //CREO UNA VARIABLE TIPO FILEREADER
          var reader = new FileReader();
          console.log(input.files[0]);
          tipodedig = input.files[0].type;
          nombredelpdf = input.files[0].name;
          reader.onload = function (e) {
            //CUANDO LA VARIABLE FILEREADER ES CARGADA CON UN ARCHIVO
            //GUARDO LA IMAGEN EN BASE64 EN LA VARIABLE
            imagenenbase64peluche = e.target.result;



            //MUESTOR LA IMAGEN EN BASE64 EN UNA ETIQUETE IMG
            document.getElementById("fotoengrandepeluche").src = imagenenbase64peluche;
          };
          //PONGO AL FILEREADER A LLER EL ARCHIVO DE LA IMAGEN
          reader.readAsDataURL(input.files[0]);

        }
        else {

          alert("Archivo demasiado grande, excede los 2 MB de limite por archivo, intente con un formato menos pesado");
        }
      }
    }


    function readURLpeluche(input) {
      if (input.files && input.files[0]) {
        //SI EL ARCHIVO ES MENOR A 2 MEGAS
        if (input.files[0].size < 2097152) {
          //CREO UNA VARIABLE TIPO FILEREADER
          var reader = new FileReader();
          console.log(input.files[0]);
          tipodedig = input.files[0].type;
          nombredelpdf = input.files[0].name;
          reader.onload = function (e) {
            //CUANDO LA VARIABLE FILEREADER ES CARGADA CON UN ARCHIVO
            //GUARDO LA IMAGEN EN BASE64 EN LA VARIABLE
            imagenenbase64peluche = e.target.result;



            //MUESTOR LA IMAGEN EN BASE64 EN UNA ETIQUETE IMG
            document.getElementById("inputimagenminiaturapeluche").src = imagenenbase64peluche;
          };
          //PONGO AL FILEREADER A LLER EL ARCHIVO DE LA IMAGEN
          reader.readAsDataURL(input.files[0]);

        }
        else {

          alert("Archivo demasiado grande, excede los 2 MB de limite por archivo, intente con un formato menos pesado");
        }
      }
    }


    function registrarse() {
      var persona = new Object();
      persona.nombre = document.getElementById("inputnombre").value;
      persona.apellidos = document.getElementById("inputapellidos").value;
      persona.email = document.getElementById("inputEmail").value;
      persona.direccion = document.getElementById("inputdireccion").value;
      persona.celular = document.getElementById("inputcel").value;
      persona.edad = document.getElementById("inputedad").value;
      persona.alergias = document.getElementById("inputalergias").value;
      persona.tamanno = document.getElementById("inputtamanno").value;
      persona.peluches = vectordepeluches;
      //PASO COMO NUEVO ATRIBUTO DEL OBJETO LA IMAGEN(SIEMPRE EN BASE64)
      persona.imagen = imagenenbase64;
      $.ajax({
        url: 'api/registrarpersona',
        type: 'PUT',
        dataType: 'json',
        data: persona,
        success: function (data, textStatus, xhr) {
          rellenatabla(data)
        },
        error: function (xhr, textStatus, errorThrown) { alert(xhr); }
      });


    }
    
    function rellenatabla(vector) {
      listadepersonas = vector;
      document.getElementById('filasdelatabla').innerHTML = "";
      for (var ele in vector) {
        var tabladepeluches = '<table>';
        for (var elem in vector[ele].peluches) {

          tabladepeluches += '<tr><td>' + vector[ele].peluches[elem].forma + ' - ' + vector[ele].peluches[elem].color + '</td><td><img id= ' + vector[ele].peluches[elem].color + ' src= ' + vector[ele].peluches[elem].foto + ' style="border-radius: 50%;cursor:pointer;width:20px;"  onclick = "cargarfotopequeengrande(this)" data-bs-toggle="modal" data-bs-target="#ModalFoto" />  </td><td><input type= "button" value= "Modificar" onclick= cargadatosmodpeluche(\'' + vector[ele].peluches[elem].color + '\')  data-bs-toggle="modal" data-bs-target="#ModalFoto" />  </td><td><input type= "button" value= "Eliminar" onclick= eliminarpeluche(\'' + vector[ele].peluches[elem].color + '\')   />  </td></tr>'

        }
        tabladepeluches += '</table>'

        document.getElementById('filasdelatabla').innerHTML += '<tr><td><img id=foto' + vector[ele].nombre + ' src= ' + vector[ele].imagen + ' style="border-radius: 50%;cursor:pointer;width:90px;" />  </td><td>' + vector[ele].nombre + '</td><td>' + vector[ele].apellidos + '</td><td>' + vector[ele].email + '</td><td>' + vector[ele].direccion + '</td><td>' + vector[ele].celular + '</td><td>' + vector[ele].edad + '</td><td>' + vector[ele].alergias + '</td><td>' + vector[ele].tamanno + '</td><td>' + tabladepeluches + '</td><td><button  data-bs-toggle="modal" data-bs-target="#exampleModal" class="btn btn-primary" onclick="modificar(\'' + vector[ele]._id + '\')">Modificar</button></td><td><button class="btn btn-primary" onclick="eliminar(\'' + vector[ele]._id + '\')">Eliminar</button></td></tr>';

      }
    }

    function cargadatosmodpeluche(colorpeluche) {
      for (var ele in listadepersonas) {

        for (var elem in listadepersonas[ele].peluches) {
          if (listadepersonas[ele].peluches[elem].color == colorpeluche) {
            document.getElementById("fotoengrandepeluche").src = listadepersonas[ele].peluches[elem].foto;
            document.getElementById("inputcolormod").value = listadepersonas[ele].peluches[elem].color;
            document.getElementById("inputformamod").value = listadepersonas[ele].peluches[elem].forma;
            break;
          }
        }

      }
    }

    function listar() {
      var persona = new Object();


      $.ajax({
        url: 'api/todaslaspersonas',
        type: 'GET',
        dataType: 'json',
        data: persona,
        success: function (data, textStatus, xhr) {

          console.log(data);

          rellenatabla(data);

        },
        error: function (xhr, textStatus, errorThrown) {


          alert(xhr);
        }
      });


    }
    function eliminar(idparametro) {
      var persona = new Object();
      persona.id = idparametro;

      $.ajax({
        url: 'api/eliminapersona',
        type: 'DELETE',
        dataType: 'json',
        data: persona,
        success: function (data, textStatus, xhr) {

          console.log(data);
          rellenatabla(data);


        },
        error: function (xhr, textStatus, errorThrown) { alert(xhr); }
      });
    }
    //FUNCION QUE S EEJECUTA AL PRESIONAR SOBRE EL BOTON DE MODIFICAR DE LA LISTA
    function modificar(idparametro) {
      for (var ele in listadepersonas) {
        if (idparametro == listadepersonas[ele]._id) {
          document.getElementById("idamodificar").value = idparametro;
          document.getElementById("inputnombremod").value = listadepersonas[ele].nombre;
          document.getElementById("inputapellidosmod").value = listadepersonas[ele].apellidos;
          document.getElementById("inputEmailmod").value = listadepersonas[ele].email;
          document.getElementById("inputdireccionmod").value = listadepersonas[ele].direccion;
          document.getElementById("inputcelmod").value = listadepersonas[ele].celular;
          document.getElementById("inputedadmod").value = listadepersonas[ele].edad;
          document.getElementById("inputalergiasmod").value = listadepersonas[ele].alergias;
          document.getElementById("inputtamannomod").value = listadepersonas[ele].tamanno;
          document.getElementById("imgregistroengrande").src = listadepersonas[ele].imagen;

          break;

        }
      }
      //RELLENO LOS DATOS DEL MODAL CON LOS DATOS DE LA PERSONA DE LA LISTA
    }


    var vectordepeluches = [];
    function agregarpeluche() {

      var peluches = new Object();
      peluches.forma = document.getElementById("inputforma").value;
      peluches.color = document.getElementById("inputcolor").value;
      peluches.foto = imagenenbase64peluche;
      vectordepeluches.push(peluches);
      rellenatablapeluches();
    }
    function rellenatablapeluches() {
      document.getElementById("filasdepeluches").innerHTML = "";
      for (var ele in vectordepeluches) {

        document.getElementById("filasdepeluches").innerHTML += "<tr><td>" + vectordepeluches[ele].forma + "</td><td>" + vectordepeluches[ele].color + "</td><td><img src= " + vectordepeluches[ele].foto + " style='border-radius: 50%;cursor:pointer;width:40px;' /></td><td><input type='button' value= 'Eliminar' onclick= 'eliminapeluches(\"" + vectordepeluches[ele].color + "\")'/></td></tr>";

      }

    }

    function eliminapeluches(color) {

      for (var ele in vectordepeluches) {

        if (vectordepeluches[ele].color == color) {
          vectordepeluches.splice(ele, 1);
        }

      }
      rellenatablapeluches();
    }

    function modificarconajax() {
      //PADO COMO OBJETO DE JAVASCRIPT LA PERSONA CON LOS CAMPOS RELLENOS DEL FORMULAIRO DEL MODAL, PARA MI EL NOMBRE ES LA LLAVE
      var persona = new Object();
      persona.nombre = document.getElementById("inputnombremod").value;
      persona.apellidos = document.getElementById("inputapellidosmod").value;
      persona.email = document.getElementById("inputEmailmod").value;
      persona.direccion = document.getElementById("inputdireccionmod").value;
      persona.celular = document.getElementById("inputcelmod").value;
      persona.edad = document.getElementById("inputedadmod").value;
      persona.alergias = document.getElementById("inputalergiasmod").value;
      persona.tamanno = document.getElementById("inputtamannomod").value;
      persona.id = document.getElementById("idamodificar").value;
      persona.imagen = document.getElementById("imgregistroengrande").src;


      $.ajax({
        url: 'api/modificarpersona',
        type: 'POST',
        dataType: 'json',
        data: persona,
        success: function (data, textStatus, xhr) {
          //SI EL SERVIDOR RESPONDE CORRECTAMENTE, VUELVO A LLAMAR A LA FUNCION DE RELLENAR TABLA
          console.log(data);
          rellenatabla(data);
        },
        error: function (xhr, textStatus, errorThrown) { alert(xhr); }
      });
    }
    function cargarfotopequeengrande(input) {
      document.getElementById('nombrepelucheendetalle').innerHTML = input.id;
      document.getElementById("fotoengrandepeluche").src = input.src;

    }

    function modificarfotopeluche() {

      for (var ele in listadepersonas) {

        for (var elem in listadepersonas[ele].peluches) {
          if (listadepersonas[ele].peluches[elem].color == document.getElementById("inputcolormod").value) {
            listadepersonas[ele].peluches[elem].foto = document.getElementById("fotoengrandepeluche").src;
            listadepersonas[ele].peluches[elem].forma = document.getElementById("inputformamod").value;
            break;
          }
        }
      }
      modificarconajaxypeluches();
    }

    function modificarconajaxypeluches() {
      //PADO COMO OBJETO DE JAVASCRIPT LA PERSONA CON LOS CAMPOS RELLENOS DEL FORMULAIRO DEL MODAL, PARA MI EL NOMBRE ES LA LLAVE
      var persona = new Object();
      persona.listanuevadepersonas = listadepersonas;


      $.ajax({
        url: 'api/reemplazapersonas',
        type: 'POST',
        dataType: 'json',
        data: persona,
        success: function (data, textStatus, xhr) {
          //SI EL SERVIDOR RESPONDE CORRECTAMENTE, VUELVO A LLAMAR A LA FUNCION DE RELLENAR TABLA
          
          console.log(data);
          rellenatabla(data);


        },
        error: function (xhr, textStatus, errorThrown) { alert(xhr); }
      });
    }

  </script>
</body>

</html>